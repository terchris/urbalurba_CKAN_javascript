var CKANData = 
    {
        "help": "http://localhost/api/3/action/help_show?name=organization_list",
        "success": true,
        "result": [
            {
                "package_count": 0,
                "num_followers": 0,
                "contact_name": "",
                "id": "d3667f87-1c00-4e31-a8b7-b57412b4ce78",
                "users": [
                    {
                        "email_hash": "7dd9ca69c40a926bd4f4ad16834b25b5",
                        "about": null,
                        "capacity": "admin",
                        "name": "terchris",
                        "created": "2018-04-03T20:36:36.374678",
                        "openid": null,
                        "sysadmin": true,
                        "activity_streams_email_notifications": false,
                        "state": "active",
                        "number_of_edits": 34,
                        "display_name": "terchris",
                        "fullname": null,
                        "id": "864bea2d-00aa-48b5-80c4-c1e5ee143bea",
                        "number_created_packages": 0
                    },
                    {
                        "email_hash": "ace0886cc633d694ab9fd1b38a68dfad",
                        "about": null,
                        "capacity": "member",
                        "name": "terje_frode",
                        "created": "2018-04-05T15:44:23.139408",
                        "openid": null,
                        "sysadmin": false,
                        "activity_streams_email_notifications": false,
                        "state": "active",
                        "number_of_edits": 0,
                        "display_name": "Frode Kjos",
                        "fullname": "Frode Kjos",
                        "id": "dd660fdc-bd59-4e9a-b223-54474bf6968c",
                        "number_created_packages": 0
                    }
                ],
                "display_name": "Acando",
                "approval_status": "approved",
                "title": "Acando",
                "member": "yes",
                "state": "active",
                "type": "organization",
                "website": "https://www.acando.no/",
                "description": "Acando er et konsulentselskap som jobber med digitale transformasjoner i offentlig og private virksomheter. Vi forbedrer og effektiviserer virksomheter, prosesser og tjenester ved hjelp av IKT.",
                "main_adddress": "Tordenskiolds gate 8-10, 0160 OSLO",
                "contact_email": "",
                "organization_number": "979191138",
                "slogan": "Digitalt konsulentselskap",
                "name": "acando2",
                "created": "2018-04-05T14:00:49.935308",
                "organization_type": "private",
                "image_display_url": "http://urbalurba.no/dataset/27695b10-8987-42d4-87ce-e0a172293cd4/resource/258860d5-881f-455d-bae8-03216d6c9c5d/download/acando-400x200.png",
                "is_organization": true,
                "image_url": "http://urbalurba.no/dataset/27695b10-8987-42d4-87ce-e0a172293cd4/resource/258860d5-881f-455d-bae8-03216d6c9c5d/download/acando-400x200.png",
                "revision_id": "13c0d937-d09d-4709-9f95-34e389bfe8a5"
            },
            {
                "package_count": 0,
                "num_followers": 0,
                "type": "organization",
                "contact_name": "Vibeke Solheim",
                "id": "6d7276ad-8591-4063-b30b-27be23a287a4",
                "users": [
                    {
                        "email_hash": "7dd9ca69c40a926bd4f4ad16834b25b5",
                        "about": null,
                        "capacity": "admin",
                        "name": "terchris",
                        "created": "2018-04-03T20:36:36.374678",
                        "openid": null,
                        "sysadmin": true,
                        "activity_streams_email_notifications": false,
                        "state": "active",
                        "number_of_edits": 34,
                        "display_name": "terchris",
                        "fullname": null,
                        "id": "864bea2d-00aa-48b5-80c4-c1e5ee143bea",
                        "number_created_packages": 0
                    },
                    {
                        "email_hash": "48736e4e153e4e88843ff3d4f87b0949",
                        "about": "Grunder i Smarte Byer Norge",
                        "capacity": "member",
                        "name": "terje",
                        "created": "2018-04-05T15:20:31.532878",
                        "openid": null,
                        "sysadmin": false,
                        "activity_streams_email_notifications": false,
                        "state": "active",
                        "number_of_edits": 0,
                        "display_name": "Terje Christensen",
                        "fullname": "Terje Christensen",
                        "id": "1385124a-5445-45f5-bc44-2ebf523510d2",
                        "number_created_packages": 0
                    }
                ],
                "display_name": "Agenda Kaupang",
                "approval_status": "approved",
                "title": "Agenda Kaupang",
                "member": "yes",
                "state": "active",
                "contact_phone": "67575700",
                "website": "http://agendakaupang.no/",
                "description": "Agenda Kaupang er et norsk konsulentselskap. Vi tilbyr analyse, utredning og r\u00e5dgiving innen omr\u00e5dene ledelse, styring, \u00f8konomi og organisasjonsutvikling. Agenda Kaupangs kunder er prim\u00e6rt i offentlig sektor, samt blant bedrifter og organisasjoner i arbeidslivet.",
                "main_adddress": "Holtet 45, 1368 Stabekk",
                "contact_email": "firmapost@agendakaupang.no",
                "organization_number": "968938525",
                "slogan": "R\u00e5dgivere for offentlig sekto",
                "name": "agenda-kaupang",
                "created": "2018-04-05T00:29:43.008806",
                "organization_type": "private",
                "image_display_url": "http://urbalurba.no/dataset/27695b10-8987-42d4-87ce-e0a172293cd4/resource/1fae2284-d7b8-4b28-bb81-7f7a3f0ecee1/download/agenda_kaupang-400x200.png",
                "is_organization": true,
                "image_url": "http://urbalurba.no/dataset/27695b10-8987-42d4-87ce-e0a172293cd4/resource/1fae2284-d7b8-4b28-bb81-7f7a3f0ecee1/download/agenda_kaupang-400x200.png",
                "revision_id": "170aab9d-4661-4a87-afc8-1b5498b46371"
            },
            {
                "package_count": 0,
                "num_followers": 0,
                "contact_name": "Harald Jellum",
                "id": "0ee0a15f-820f-428a-ab88-ed5da07e15cd",
                "users": [
                    {
                        "email_hash": "7dd9ca69c40a926bd4f4ad16834b25b5",
                        "about": null,
                        "capacity": "admin",
                        "name": "terchris",
                        "created": "2018-04-03T20:36:36.374678",
                        "openid": null,
                        "sysadmin": true,
                        "activity_streams_email_notifications": false,
                        "state": "active",
                        "number_of_edits": 34,
                        "display_name": "terchris",
                        "fullname": null,
                        "id": "864bea2d-00aa-48b5-80c4-c1e5ee143bea",
                        "number_created_packages": 0
                    }
                ],
                "display_name": "AiSpot",
                "approval_status": "approved",
                "title": "AiSpot",
                "member": "yes",
                "state": "active",
                "type": "organization",
                "website": "https://aispot.no/",
                "description": "Aispot helps retail and destinations engage customers and increase loyalty. Enabling the concept of Future Shopping. Clients Simply connect to \u2013 and publish to their customers through a shared mobile platform utilizing beacons, QR, club, mobile Wallet and a range of ready-made services",
                "main_adddress": "Bryggegata 3, 0250 OSLO",
                "contact_email": "",
                "organization_number": "915939678",
                "slogan": "IoT og app for varehandel og reiseliv",
                "name": "aispot",
                "created": "2018-04-03T20:57:42.520966",
                "organization_type": "startup",
                "image_display_url": "http://urbalurba.no/dataset/27695b10-8987-42d4-87ce-e0a172293cd4/resource/419ecbe2-3432-47c2-936f-53a4e979b519/download/aispot-400x200.png",
                "is_organization": true,
                "image_url": "http://urbalurba.no/dataset/27695b10-8987-42d4-87ce-e0a172293cd4/resource/419ecbe2-3432-47c2-936f-53a4e979b519/download/aispot-400x200.png",
                "revision_id": "ef0db7d5-8ce7-44e2-bc65-e98b71feb982"
            },
            {
                "package_count": 0,
                "num_followers": 0,
                "type": "organization",
                "contact_name": "Wilfried Pimenta De Miranda",
                "id": "fb790b29-543a-4124-a9cb-5e4dbb948099",
                "users": [
                    {
                        "email_hash": "7dd9ca69c40a926bd4f4ad16834b25b5",
                        "about": null,
                        "capacity": "admin",
                        "name": "terchris",
                        "created": "2018-04-03T20:36:36.374678",
                        "openid": null,
                        "sysadmin": true,
                        "activity_streams_email_notifications": false,
                        "state": "active",
                        "number_of_edits": 34,
                        "display_name": "terchris",
                        "fullname": null,
                        "id": "864bea2d-00aa-48b5-80c4-c1e5ee143bea",
                        "number_created_packages": 0
                    }
                ],
                "display_name": "Alpha Venturi",
                "approval_status": "approved",
                "title": "Alpha Venturi",
                "member": "yes",
                "state": "active",
                "contact_phone": "92202918",
                "website": "http://www.alpha-venturi.com/",
                "description": "Alpha Venturi is a strategic innovation lab and venture launchpad for Impact. We harvest exponential technologies, explore disruptive business models and grow new ventures to shape a better tomorrow. We bring expertise in Blockchain and Distributed Ledger Technologies, Internet of Things (IoT), Internet of Me / MyData",
                "main_adddress": "\u00c5sterudsletta 101, 1344 HASLUM",
                "contact_email": "contact@alpha-venturi.com",
                "organization_number": "918035591",
                "slogan": "Akselerator og venture",
                "name": "alpha-venturi",
                "created": "2018-04-04T01:16:32.196650",
                "organization_type": "startup",
                "image_display_url": "http://urbalurba.no/dataset/27695b10-8987-42d4-87ce-e0a172293cd4/resource/bd2ef91f-18b9-418d-9c76-ee6f8b79bcd3/download/dummy-400x200.png",
                "is_organization": true,
                "image_url": "http://urbalurba.no/dataset/27695b10-8987-42d4-87ce-e0a172293cd4/resource/bd2ef91f-18b9-418d-9c76-ee6f8b79bcd3/download/dummy-400x200.png",
                "revision_id": "236f9cc5-3039-4c23-aa61-4895dd8c19f0"
            },
            {
                "package_count": 0,
                "num_followers": 0,
                "type": "organization",
                "contact_name": "",
                "id": "d9afd93f-e591-4525-ad32-8e4326ea020a",
                "users": [
                    {
                        "email_hash": "7dd9ca69c40a926bd4f4ad16834b25b5",
                        "about": null,
                        "capacity": "admin",
                        "name": "terchris",
                        "created": "2018-04-03T20:36:36.374678",
                        "openid": null,
                        "sysadmin": true,
                        "activity_streams_email_notifications": false,
                        "state": "active",
                        "number_of_edits": 34,
                        "display_name": "terchris",
                        "fullname": null,
                        "id": "864bea2d-00aa-48b5-80c4-c1e5ee143bea",
                        "number_created_packages": 0
                    }
                ],
                "display_name": "Atea",
                "approval_status": "approved",
                "title": "Atea",
                "member": "yes",
                "state": "active",
                "contact_phone": "22095000",
                "website": "htp://www.atea.no",
                "description": "Atea er r\u00e5dgivere for teknologiske l\u00f8sninger og bruker v\u00e5r kompetanse til \u00e5 forme et bedre Norge. I samarbeid med kunder og partnere utvikler vi l\u00f8sningene neste generasjon kan v\u00e6re stolte av.",
                "main_adddress": "Brynsalleen 2, 0667 Oslo, Norge",
                "contact_email": "",
                "organization_number": "976239997",
                "slogan": "Sammen digitaliserer vi Norge",
                "name": "atea",
                "created": "2018-04-05T01:54:16.676161",
                "organization_type": "private",
                "image_display_url": "http://urbalurba.no/dataset/27695b10-8987-42d4-87ce-e0a172293cd4/resource/34bac524-f39e-4b7a-a6d6-4ac01e630c2e/download/atea-400x200.png",
                "is_organization": true,
                "image_url": "http://urbalurba.no/dataset/27695b10-8987-42d4-87ce-e0a172293cd4/resource/34bac524-f39e-4b7a-a6d6-4ac01e630c2e/download/atea-400x200.png",
                "revision_id": "46650d15-7da7-4e52-aff3-de66041740ff"
            }
        ]
    }





function tags(tags) {
  return `
  ${tags.map(tag => ` ${tag} `).join("")}
`;
}



function isJson(str) {
    try {
        JSON.parse(str);
    } catch (e) {
        return false;
    }
    return true;
}


function setUserProperties(user) {
    // The user.about field is free txt. This code figures out how to read it.
    // If the field is empty. Well then its empty and we do nothing
    // if it contains text. Then we display the text (no test for lenght)
    // if it is a json string we try to get the fields

    // The user.about json looks like this { "title":"Boss", "aboutdisplay":"Self made man and genius", "profilepictureurl":"http://icons.iconarchive.com/icons/designbolts/free-male-avatars/128/Male-Avatar-Bowler-Hat-icon.png", "phone":"90054123", "email":"jalmar@jalla.no"}


    user.userProfileURL= ckanServer + "user/" + user.name; //Set the URL you go to when clicking on the user
    user.profilepictureurl = ""; // assume no picture



    if ($.isEmptyObject(user.about)) {
        user.aboutdisplay = ""; // about field is empty - don't display anything about the user
    } else if (isJson(user.about)) {
        // the about field contains a json string
        var userAboutObj = JSON.parse(user.about);
        for (var i in userAboutObj) {
            user[i] = userAboutObj[i]; // copy the attributes. whatever they may be
        }
        if (user.title != "") {
            user.aboutdisplay = user.title; // Display the tilte if there is one
        }

    } else {
        user.aboutdisplay = user.about; // there is some text there. Assume we can just display it
    }


    return user;
}





/* Figuring out what icon to symbolize organisation type
Icon set https://linearicons.com/free
*/
function orgType(orgType) {
  
    const researchIcon = 'lnr-graduation-hat';  
    const publicIcon = 'lnr-shirt';  /*TODO: find other */
    const startupIcon = 'lnr-rocket';
    const privateIcon = 'lnr-apartment';
    const civilSocietyIcon = 'lnr-dinner';  /*TODO: find other */  
    const defaultIcon = 'lnr-question-circle';
    
    var icon = '';
    var orgTypeDisplayTxt = '';  
    /* The case values here must correspond with the names in the extended schema for urbalurba*/
    switch (orgType) {
    case 'research':
      icon = researchIcon;
      orgTypeDisplayTxt = 'FoU';
      break;
    case 'public':
      icon = publicIcon;
      orgTypeDisplayTxt = 'Offentlig';
      break;      
    case 'startup':
      icon = startupIcon;
      orgTypeDisplayTxt = 'Startup';
      break;   
    case 'private':
      icon = privateIcon;
      orgTypeDisplayTxt = 'Privat';
      break;   
    case 'civil_society':
      icon = civilSocietyIcon;
      orgTypeDisplayTxt = 'Sivilsamfunn';
      break;   
        
    default: 
      icon = defaultIcon;  
  }
  
  
    
    return `
  <!--- Org type icon start -->                  
  <div class="card-img-overlay ">
    <a href="" ><span class="lnr ${icon}" data-toggle="tooltip" data-placement="bottom" title="${orgTypeDisplayTxt}"></span></a>
  </div>
  <!--- Org type iCon end -->                                 `;
  }   
  



function avatars(users) {
    
    return `
  <!-- Start avatars -->
  <ul class="avatars">
    ${users.map(users => ` 
    <li>
        <a href="${users.userProfileURL}" data-toggle="tooltip" data-placement="top" title="${users.display_name} ${users.aboutdisplay}">
            <img src="${users.profilepictureurl}" onError="this.onerror=null;this.src='${avatarImageDefaut}';">
        </a>
    </li>
  
    `).join("")}
  </ul>      
  <!-- stop avatars --> 
`;
}




function memberTemplate(member) {
    return `
  <div class="col-lg-3 col-md-4 col-sm-6">
  <div class="card">
  
    ${member.organization_type ? orgType(member.organization_type) : ""}
  
      <img class="card-img-top img-fluid" src="${member.image_display_url}"
          alt="${member.display_name}">
  
  
          ${member.users ? avatars(member.users) : ""}
  
      <div class="card-body">
          <h4 class="card-title">${member.display_name}</h4>
          <h6 class="card-subtitle mb-2 text-muted">${member.slogan}</h6>
          <p class="card-text">${member.description}</p>
      </div>


  
      <div class="card-footer text-muted">
            <small class="text-muted">
                Tags:
                ${member.tags ? tags(member.tags) : ""}
            </small>
      </div>
  </div>
  <!-- end card -->
  </div>
    `;
  }
  




function isAdminUser(name){
// Check if a user is in the lis of admins that should not be displayed
// return true if the user is an admin

    isAdminUserReturn = false;
    for (var i=0; i<=adminUsersToRemove.length;i++){
        if (adminUsersToRemove[i] == name) {
            isAdminUserReturn = true;
            break;
        } 

    }
 return isAdminUserReturn;
}




function filterOrganizations(members){
// Remove the organizations that are not "member": "yes",
// Remove the ckan admin user from the list of users in the organization
// call setUserProperties to figure out how to intepret the user.about field

    newMemberArray =[]; // All members are copied into this array.
    

    for (var i=0; i < members.length;i++) {    //loop members
        if (members[i].member == 'yes') {  // we want only those marked member

            newMember = JSON.parse(JSON.stringify(members[i])); // copy the full member object
            originalNumUsers =  newMember.users.length; // count the original number
            delete newMember.users;  //delete the users
            let newUserArray =[]; // we will copy all user that are not admin into this array

            for (var usrcount=0; usrcount < originalNumUsers; usrcount++) { // loop users
                
                if  (isAdminUser(members[i].users[usrcount].name)) { 
                    console.log("Admin user removed from : " + members[i].name) // not copied the admin user
                } else {          
                    theUser= setUserProperties(members[i].users[usrcount]); // set the properties for the user           
                    newUserArray.push( theUser);            // and add it to the new list of users belonging to the org
                }
            } 
            newMember.users = JSON.parse(JSON.stringify(newUserArray)); // seems to be the way one copies an array in javascript
            newMemberArray.push( newMember); // copy the organization. it is a member
        } else {
            // organization from result set in CKAN is not a member
            console.log("Not a member" + members[i].display_name);
        }

    }

    return newMemberArray;

}






    var ckanServer = "http://urbalurba.no"; // change to your own to test or use http://demo.ckan.org
    ckanServer = "http://172.16.1.96/";
    //var avatarImageDefaut="http://icons.iconarchive.com/icons/designbolts/free-male-avatars/128/Male-Avatar-Bowler-Hat-icon.png";
    var avatarImageDefaut="http://icons.iconarchive.com/icons/icons8/windows-8/128/Users-Name-icon.png";
    
    var organizationImageDefaut="";
    let adminUsersToRemove = ["terchris"]; // the ckan main admin is usually a member. so remove that one

    

function loadOrganizationsFromCKAN(){

    
    var organization_list_api = "/api/3/action/organization_list"; //the API. See http://docs.ckan.org/en/latest/api/index.html?highlight=organization_list#ckan.logic.action.get.organization_list
    var ckanURL = ckanServer + organization_list_api;
    var ckanParameters = { all_fields: "true" , include_extras: "true", include_users: "true" }; // See API description for what parameters to use



  $.ajax({
    url: ckanURL,
    dataType: "jsonp",  // required: we want jsonp. See why here https://en.wikipedia.org/wiki/JSONP                
    data: ckanParameters,   // optional: but we use it to get all fields in this example
    cache: "false"      // optional: tell it to get it from the server each time                
})
    .done(function (data) {
        if (data.success == true) { // CKAN sets success = true if the API was OK
            document.getElementById("numMembers").innerHTML = 
            `
            ${data.result.length} 
            `;

            justMembers = filterOrganizations(data.result); // add and remove stuff

            document.getElementById("app").innerHTML = `
  
            ${justMembers.map(memberTemplate).join("")}
           
           `;
        } 
    })
    .fail(function () {
        alert( "Failed for some reason" );
    });
  
}

function loadOrganizationsFromDummyCKAN(){
    document.getElementById("numMembers").innerHTML = 
    `
    ${CKANData.result.length} 
    `;
    
    
    document.getElementById("app").innerHTML = `
    
     ${CKANData.result.map(memberTemplate).join("")}
    
    `;



}




  /**** Stuff below here are for testing */



  function myButton() {
    document.getElementById("SBN").style.color = "blue";
}



$().ready(function(){
    $('[rel="tooltip"]').tooltip();

});

function rotateCard(btn){
    var $card = $(btn).closest('.card-container');
            document.getElementById("SBN").style.color = "blue";
    if($card.hasClass('hover')){
        $card.removeClass('hover');
    } else {
        $card.addClass('hover');
    }
}



/*
var data = {all_fields: true};
//var data = {};
  $.ajax({
    url: 'http://urbalurba.no/api/3/action/organization_list',
    data: data,
    dataType: 'jsonp',
    success: function(data) {
      alert('Total results found: ' + data.result.total)
      console.log("We can read all record in a dataset:", JSON.stringify(result));
    }
  });
  

  var data = {
    resource_id: 'c93dc25b-4335-4416-afde-bdee5388044a', // the resource id
    limit: 5, // get 5 results
    q: 'jones' // query for 'jones'
  };
  $.ajax({
    url: 'http://172.16.1.96/api/3/action/datastore_search',
    data: data,
    dataType: 'jsonp',
    success: function(data) {
      alert('Total results found: ' + data.result.total)
    }
  });

*/










